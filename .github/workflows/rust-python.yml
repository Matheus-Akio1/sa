name: Rust-Python Tests

on:
  push:
    branches: [ main, feat/rust-python-bindings ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  rust-tests:
    name: Run Rust Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: rust_forecast/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build Rust library
      working-directory: ./rust_forecast
      run: cargo build --verbose
    
    - name: Run Rust tests
      working-directory: ./rust_forecast
      run: cargo test --verbose

  python-integration:
    name: Python Integration Tests
    runs-on: ubuntu-latest
    needs: rust-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Install maturin
      run: |
        pip install maturin
    
    - name: Build Python package
      working-directory: ./rust_forecast
      run: |
        maturin develop
    
    - name: Test Python import
      working-directory: ./rust_forecast
      run: |
        python -c "import rust_forecast; print('Module imported successfully'); result = rust_forecast.predict([1.0, 2.0, 3.0]); print('Prediction result:', result); assert result == [1.0, 2.0, 3.0], 'Unexpected result'"
    
    - name: Run Python integration tests
      working-directory: ./rust_forecast
      run: |
        python tests_py/test_import.py
